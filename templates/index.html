<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—é“ºæ¨èç³»ç»Ÿ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .description {
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .input-group input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(39, 174, 96, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #3498db, #2980b9);
            box-shadow: 0 4px 6px rgba(41, 128, 185, 0.2);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 8px rgba(41, 128, 185, 0.3);
        }
        
        .user-profile {
            display: none;
            width: 100%;
            background: linear-gradient(to right, #f8f9fa, #ecf0f1);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }
        
        .profile-header {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-header i {
            color: #3498db;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding: 15px 0;
        }
        
        .profile-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .profile-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .profile-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .recommendations {
            display: none;
            width: 100%;
        }
        
        .rec-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .rec-user {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .rec-type {
            font-size: 1.1rem;
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .rec-list {
            list-style-type: none;
        }
        
        .rec-item {
            background: white;
            border-left: 4px solid #2ecc71;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
        }
        
        .rec-item:hover {
            transform: translateX(5px);
        }
        
        .rank-badge {
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .store-name {
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        @media (max-width: 480px) {
            .container {
                width: 95%;
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .rec-item {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸª åº—é“ºæ¨èç³»ç»Ÿ</h1>
        <p class="description">è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·IDï¼Œè·å–ä¸ªæ€§åŒ–åº—é“ºæ¨è</p>
        
        <div class="login-form">
            <div class="input-group">
                <label for="user_id">ç”¨æˆ·ID</label>
                <input type="text" id="user_id" placeholder="ä¾‹å¦‚ï¼š123" value="12">
            </div>
            <button class="btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> ç™»å½•
            </button>
            <div class="error" id="error"></div>
        </div>

                <!-- åœ¨ç”¨æˆ·ç™»å½•è¡¨å•åæ·»åŠ æ–°ç”¨æˆ·æ³¨å†Œè¡¨å• -->
        <div class="new-user-form" id="new-user-form" style="display: none;">
            <div class="section-header">
                <i class="fas fa-user-plus"></i> æ–°ç”¨æˆ·æ³¨å†Œ
                <p>è¯·å¡«å†™æ‚¨çš„ä¸ªäººä¿¡æ¯ä»¥ä¾¿è·å¾—ä¸ªæ€§åŒ–æ¨è</p>
            </div>

            <div class="input-group">
                <label for="gender">æ€§åˆ«</label>
                <select id="gender" class="form-input">
                    <option value="M">ç”·</option>
                    <option value="F">å¥³</option>
                </select>
            </div>

            <div class="input-group">
                <label for="age">å¹´é¾„</label>
                <input type="number" id="age" class="form-input" placeholder="ä¾‹å¦‚ï¼š25" min="18" max="100">
            </div>

            <div class="input-group">
                <label for="occupation">èŒä¸š</label>
                <select id="occupation" class="form-input">
                    <option value="0">å…¶ä»–</option>
                    <option value="1">å­¦æœ¯/æ•™è‚²</option>
                    <option value="2">è‰ºæœ¯å®¶</option>
                    <option value="3">æ–‡å‘˜/è¡Œæ”¿</option>
                    <option value="4">å¤§å­¦ç”Ÿ</option>
                    <option value="5">å®¢æˆ·æœåŠ¡</option>
                    <option value="6">åŒ»ç”Ÿ/åŒ»ç–—</option>
                    <option value="7">ç®¡ç†</option>
                    <option value="8">å†œæ°‘</option>
                    <option value="9">å®¶åº­ä¸»å¦‡</option>
                    <option value="10">å­¦ç”Ÿ</option>
                    <option value="11">å¾‹å¸ˆ</option>
                    <option value="12">ç¨‹åºå‘˜</option>
                    <option value="13">é€€ä¼‘</option>
                    <option value="14">é”€å”®/è¥é”€</option>
                    <option value="15">ç§‘å­¦å®¶</option>
                    <option value="16">ä¸ªä½“ç»è¥</option>
                    <option value="17">æŠ€æœ¯å‘˜</option>
                    <option value="18">å·¥åŒ </option>
                    <option value="19">å¤±ä¸š</option>
                </select>
            </div>

            <button class="btn" onclick="saveUserInfo()">
                <i class="fas fa-save"></i> ä¿å­˜ä¿¡æ¯å¹¶è·å–æ¨è
            </button>
        </div>

        <div class="user-profile" id="user-profile">
            <div class="profile-header">
                <i class="fas fa-user-circle"></i> ç”¨æˆ·ä¿¡æ¯
            </div>
            <div class="profile-grid">
                <div class="profile-item">
                    <div class="profile-label">ç”¨æˆ·ID</div>
                    <div class="profile-value" id="profile-id">12</div>
                </div>
                <div class="profile-item">
                    <div class="profile-label">æ€§åˆ«</div>
                    <div class="profile-value" id="profile-gender">ç”·</div>
                </div>
                <div class="profile-item">
                    <div class="profile-label">å¹´é¾„</div>
                    <div class="profile-value" id="profile-age">28</div>
                </div>
                <div class="profile-item">
                    <div class="profile-label">èŒä¸š</div>
                    <div class="profile-value" id="profile-occupation">ç¨‹åºå‘˜</div>
                </div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label for="algorithm">æ¨èç®—æ³•</label>
                <select id="algorithm" class="form-input">
                    <option value="hybrid">æ··åˆæ¨èï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="user_cf">åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ (UserCF)</option>
                    <option value="item_cf">åŸºäºåº—é“ºçš„ååŒè¿‡æ»¤ (ItemCF)</option>
                    <option value="profile">ç”¨æˆ·ç”»åƒæ¨è</option> <!-- ç¡®ä¿å€¼ä¸º'profile' -->
                </select>
            </div>

            <button class="btn btn-secondary" onclick="getRecommendations()">
                <i class="fas fa-store"></i> è·å–æ¨è
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p class="loading-text">æ­£åœ¨ç”Ÿæˆæ¨èï¼Œè¯·ç¨å€™...</p>
        </div>

        <div class="recommendations" id="recommendations">
            <div class="rec-header">
                <div class="rec-user">ç”¨æˆ· <span id="rec-user-id">12</span> çš„æ¨èåº—é“º</div>
                <div class="rec-type" id="rec-type">ä¸ªæ€§åŒ–æ¨è</div>
            </div>
            <ul class="rec-list" id="rec-list"></ul>
        </div>
    </div>

        <!-- åœ¨ç”¨æˆ·ç™»å½•è¡¨å•åæ·»åŠ æ¦œå•åŒºåŸŸ -->
    <div class="leaderboard-container" id="leaderboard-container">
        <div class="section-header">
            <i class="fas fa-trophy"></i> çƒ­é—¨æ¦œå•
            <p>æ— éœ€ç™»å½•å³å¯æŸ¥çœ‹çƒ­é—¨åº—é“ºæ¨è</p>
        </div>

        <div class="leaderboard-buttons">
            <button class="leaderboard-btn" onclick="loadLeaderboard('top_popular')">
                <i class="fas fa-fire"></i> æœ€ç«çˆ†TOP10
            </button>
            <button class="leaderboard-btn" onclick="loadLeaderboard('top_rated')">
                <i class="fas fa-star"></i> è¯„åˆ†æœ€é«˜TOP10
            </button>

        </div>

        <div class="leaderboard-results" id="leaderboard-results">
            <!-- è¿™é‡Œä¼šåŠ¨æ€åŠ è½½æ¦œå•ç»“æœ -->
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼Œç”¨äºå±•ç¤ºæ¦œå•è¯¦æƒ… -->
    <div class="modal" id="leaderboard-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">çƒ­é—¨åº—é“ºæ¦œå•</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- è¿™é‡Œä¼šåŠ¨æ€å¡«å……å†…å®¹ -->
            </div>
        </div>
    </div>

    <style>
        .new-user-form {
        width: 100%;
        background: linear-gradient(to right, #f8f9fa, #ecf0f1);
        border-radius: 8px;
        padding: 25px;
        margin: 25px 0;
        border-left: 5px solid #3498db;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e6ed;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .form-input:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

        .leaderboard-container {
            width: 100%;
            margin-top: 30px;
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .section-header {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.6rem;
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .section-header i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #f39c12;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #7f8c8d;
            max-width: 600px;
            margin-top: 10px;
        }

        .leaderboard-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .leaderboard-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            box-shadow: 0 4px 6px rgba(41, 128, 185, 0.2);
        }

        .leaderboard-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(41, 128, 185, 0.3);
        }

        .leaderboard-btn:nth-child(1) {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .leaderboard-btn:nth-child(2) {
            background: linear-gradient(to right, #f39c12, #d35400);
        }

        .leaderboard-btn:nth-child(3) {
            background: linear-gradient(to right, #2ecc71, #27ae60);
        }

        .leaderboard-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s;
        }

        .leaderboard-row:hover {
            background: rgba(52, 152, 219, 0.05);
            cursor: pointer;
        }

        .rank-badge {
            width: 36px;
            height: 36px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .store-info {
            flex-grow: 1;
        }

        .store-name {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .store-genres {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .store-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalOpen 0.3s ease;
        }

        @keyframes modalOpen {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #7f8c8d;
            cursor: pointer;
            padding: 5px 10px;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #3498db;
            margin-bottom: 5px;
            text-align: center;
        }

        .modal-description {
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 25px;
        }

        .leaderboard-header {
            display: grid;
            grid-template-columns: 50px 3fr repeat(3, 1fr);
            font-weight: bold;
            padding: 15px;
            background: #f1f2f6;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .leaderboard-item {
            display: grid;
            grid-template-columns: 50px 3fr repeat(3, 1fr);
            padding: 15px;
            border-bottom: 1px solid #f1f2f6;
        }

        .leaderboard-item:nth-child(even) {
            background: #f8f9fa;
        }

        .leaderboard-item:hover {
            background: #e3f2fd;
            cursor: pointer;
        }

        .rank-value {
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .leaderboard-buttons {
                flex-direction: column;
                align-items: center;
            }

            .leaderboard-btn {
                width: 100%;
                max-width: 300px;
            }

            .leaderboard-header,
            .leaderboard-item {
                grid-template-columns: 40px 2fr 1fr;
                grid-template-rows: auto auto;
            }

            .leaderboard-header > *:nth-child(4),
            .leaderboard-header > *:nth-child(5),
            .leaderboard-item > *:nth-child(4),
            .leaderboard-item > *:nth-child(5) {
                display: none;
            }

            .store-name-cell {
                grid-column: 2 / span 2;
            }

            .store-stats {
                grid-column: 2 / span 2;
                grid-row: 2;
                justify-content: space-between;
                margin-top: 10px;
            }
        }
    </style>

    <script>
        // èŒä¸šä»£ç æ˜ å°„è¡¨
        const occupations = {
            0: "å…¶ä»–", 1: "å­¦æœ¯/æ•™è‚²", 2: "è‰ºæœ¯å®¶", 3: "æ–‡å‘˜/è¡Œæ”¿",
            4: "å¤§å­¦ç”Ÿ", 5: "å®¢æˆ·æœåŠ¡", 6: "åŒ»ç”Ÿ/åŒ»ç–—", 7: "ç®¡ç†",
            8: "å†œæ°‘", 9: "å®¶åº­ä¸»å¦‡", 10: "å­¦ç”Ÿ", 11: "å¾‹å¸ˆ",
            12: "ç¨‹åºå‘˜", 13: "é€€ä¼‘", 14: "é”€å”®/è¥é”€", 15: "ç§‘å­¦å®¶",
            16: "ä¸ªä½“ç»è¥", 17: "æŠ€æœ¯å‘˜", 18: "å·¥åŒ ", 19: "å¤±ä¸š"
        };

        function login() {
            const userId = document.getElementById('user_id').value;
            const errorDiv = document.getElementById('error');
            const userProfile = document.getElementById('user-profile');
            const loading = document.getElementById('loading');
            const recSection = document.getElementById('recommendations');

            // éšè—ä¹‹å‰çš„æ¨èç»“æœ
            recSection.style.display = 'none';

            if (!userId) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·ID';
                return;
            }

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            errorDiv.textContent = '';
            loading.style.display = 'block';
            userProfile.style.display = 'none';

            // å‘é€ç™»å½•è¯·æ±‚
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `user_id=${userId}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç™»å½•è¯·æ±‚å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                loading.style.display = 'none';

                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                document.getElementById('profile-id').textContent = data.user_id;

                if (data.user_info) {
                    // æ›´æ–°ç”¨æˆ·èµ„æ–™
                    document.getElementById('profile-gender').textContent =
                        data.user_info.gender === 'M' ? 'ç”·' : 'å¥³';
                    document.getElementById('profile-age').textContent =
                        data.user_info.age || 'æœªçŸ¥';
                    document.getElementById('profile-occupation').textContent =
                        occupations[data.user_info.occupation] || 'æœªçŸ¥';
                } else {
                    // é»˜è®¤æ˜¾ç¤º
                    document.getElementById('profile-gender').textContent = 'ç”·';
                    document.getElementById('profile-age').textContent = '28';
                    document.getElementById('profile-occupation').textContent = 'ç¨‹åºå‘˜';
                }

                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
                userProfile.style.display = 'block';

                if (data.is_new_user) {
                    // æ˜¾ç¤ºæ–°ç”¨æˆ·æ³¨å†Œè¡¨å•
                    document.getElementById('new-user-form').style.display = 'block';
                    document.getElementById('user-profile').style.display = 'none';
                } else {
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
                    document.getElementById('user-profile').style.display = 'block';
                    document.getElementById('new-user-form').style.display = 'none';
                }

            })
            .catch(error => {
                loading.style.display = 'none';
                errorDiv.textContent = error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
                console.error('ç™»å½•é”™è¯¯:', error);
            });
        }

        function saveUserInfo() {
            const userId = document.getElementById('user_id').value;
            const gender = document.getElementById('gender').value;
            const age = document.getElementById('age').value;
            const occupation = document.getElementById('occupation').value;
            const errorDiv = document.getElementById('error');

            if (!age) {
                errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ';
                return;
            }

            // å‘é€ç”¨æˆ·ä¿¡æ¯åˆ°åç«¯
            fetch('/save_user_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    gender: gender,
                    age: age,
                    occupation: occupation,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    document.getElementById('profile-gender').textContent =
                        data.user_info.gender === 'M' ? 'ç”·' : 'å¥³';
                    document.getElementById('profile-age').textContent =
                        data.user_info.age;
                    document.getElementById('profile-occupation').textContent =
                        occupations[data.user_info.occupation] || 'æœªçŸ¥';

                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
                    document.getElementById('user-profile').style.display = 'block';
                    document.getElementById('new-user-form').style.display = 'none';

                    // è‡ªåŠ¨è·å–æ¨è
                    getRecommendations();
                } else {
                    errorDiv.textContent = data.error || 'ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
                console.error('ä¿å­˜é”™è¯¯:', error);
            });
        }

        function getRecommendations() {
    const userId = document.getElementById('user_id').value;
    const algorithm = document.getElementById('algorithm').value; // è·å–é€‰æ‹©çš„ç®—æ³•
    const errorDiv = document.getElementById('error');
    const loading = document.getElementById('loading');
    const recSection = document.getElementById('recommendations');
    const recList = document.getElementById('rec-list');

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    errorDiv.textContent = '';
    loading.style.display = 'block';
    recSection.style.display = 'none';

    // ä¿®å¤ç‚¹ï¼šå‘é€å¸¦ç®—æ³•å‚æ•°çš„è¯·æ±‚
    fetch(`/recommend?algorithm=${algorithm}`) // è¿™é‡Œæ·»åŠ ç®—æ³•å‚æ•°
    .then(response => {
        if (!response.ok) {
            throw new Error('æ¨èè¯·æ±‚å¤±è´¥');
        }
        return response.json();
    })
    .then(data => {
        loading.style.display = 'none';

        if (data.error) {
            throw new Error(data.error);
        }

        // æ›´æ–°ç”¨æˆ·IDæ˜¾ç¤º
        document.getElementById('rec-user-id').textContent = data.user_id;

        // æ›´æ–°æ¨èç±»å‹
        document.getElementById('rec-type').textContent = data.rec_type || 'ä¸ªæ€§åŒ–æ¨è';

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆç¡®ä¿ä¸€è‡´ï¼‰
        if (data.user_info) {
            document.getElementById('profile-gender').textContent =
                data.user_info.gender === 'M' ? 'ç”·' : 'å¥³';
            document.getElementById('profile-age').textContent =
                data.user_info.age || 'æœªçŸ¥';
            document.getElementById('profile-occupation').textContent =
                occupations[data.user_info.occupation] || 'æœªçŸ¥';
        }

        // æ¸…é™¤æ—§åˆ—è¡¨
        recList.innerHTML = '';

        // æ·»åŠ æ¨èé¡¹ç›®
        data.recommendations.forEach(item => {
            const li = document.createElement('li');
            li.className = 'rec-item';

            li.innerHTML = `
                <div class="rank-badge">${item.rank}</div>
                <div class="store-name">${item.name}</div>
            `;

            recList.appendChild(li);
        });

        // æ˜¾ç¤ºæ¨èç»“æœ
        recSection.style.display = 'block';
    })
    .catch(error => {
        loading.style.display = 'none';
        errorDiv.textContent = error.message || 'è·å–æ¨èå¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
        console.error('æ¨èé”™è¯¯:', error);
    });
}

        // æ”¯æŒæŒ‰Enteré”®ç™»å½•
        document.getElementById('user_id').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // é¡µé¢åŠ è½½æ—¶éšè—æ¨èéƒ¨åˆ†
        window.onload = function() {
            document.getElementById('user-profile').style.display = 'none';
            document.getElementById('recommendations').style.display = 'none';
        };

        // æ·»åŠ åŠ è½½æ¦œå•çš„å‡½æ•°
        function loadLeaderboard(type) {
            const resultsDiv = document.getElementById('leaderboard-results');
            const errorDiv = document.getElementById('error');
            const modal = document.getElementById('leaderboard-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultsDiv.innerHTML = '<div class="loading-text"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½æ¦œå•æ•°æ®...</div>';
            errorDiv.textContent = '';

            // ç¡®å®šAPIç«¯ç‚¹
            let endpoint;
            switch(type) {
                case 'top_popular':
                    endpoint = '/top_popular';
                    break;
                case 'top_rated':
                    endpoint = '/top_rated';
                    break;
                case 'top_value':
                    endpoint = '/top_value';
                    break;
                default:
                    resultsDiv.innerHTML = '<div class="error">æœªçŸ¥æ¦œå•ç±»å‹</div>';
                    return;
            }

            // è·å–æ¦œå•æ•°æ®
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (!data.stores || data.stores.length === 0) {
                        resultsDiv.innerHTML = '<div class="error">æš‚æ— æ¦œå•æ•°æ®</div>';
                        return;
                    }

                    // æ›´æ–°æ ‡é¢˜
                    modalTitle.textContent = data.title;

                    // æ¸…ç©ºå¹¶å¡«å……æ¨¡æ€æ¡†å†…å®¹
                    modalBody.innerHTML = `
                        <div class="modal-title">${data.title}</div>
                        <p class="modal-description">${data.description}</p>
                        <div class="leaderboard-header">
                            <div>æ’å</div>
                            <div>åº—é“ºåç§°</div>
                            <div>è¯„è®ºæ•°</div>
                            <div>è¯„åˆ†</div>
                            <div>äººå‡æ¶ˆè´¹</div>
                        </div>
                    `;

                    // æ·»åŠ æ¯å®¶åº—é“º
                    data.stores.forEach((store, index) => {
                        const rank = index + 1;
                        const rankCell = `<div class="rank-value">${rank}</div>`;
                        const nameCell = `<div class="store-name-cell">
                            <div class="store-name">${store.title}</div>
                            <div class="store-genres">${store.genres || 'æ— åˆ†ç±»'}</div>
                        </div>`;

                        // ä¸ºä¸åŒæ¦œå•æ·»åŠ ç‰¹å®šæ•°æ®
                        let numCmtCell = `<div class="stat-item">${store.num_cmt || 0}</div>`;
                        let ratingCell = `<div class="stat-item">${store.avg_rating?.toFixed(1) || 'æ— '}</div>`;
                        let perConCell = `<div class="stat-item">${store.per_con ? 'Â¥' + store.per_con.toFixed(2) : 'æ— æ•°æ®'}</div>`;

                        // æ€§ä»·æ¯”æ¦œå•æœ‰ç‰¹æ®Šå­—æ®µ
                        if (type === 'top_value') {
                            const valueRatio = store.per_con?.toFixed(3) || 'æ— ';
                            numCmtCell = `<div class="stat-item">${store.num_cmt || 0}</div>`;
                            ratingCell = `<div class="stat-item">${store.avg_rating?.toFixed(1) || 'æ— '}</div>`;
                            perConCell = `<div class="stat-item">${store.per_con ? 'Â¥' + store.per_con.toFixed(2) : 'æ— æ•°æ®'}</div>`;
                        }

                        // åˆ›å»ºä¸€è¡Œ
                        const row = document.createElement('div');
                        row.className = 'leaderboard-item';
                        row.innerHTML = `
                            ${rankCell}
                            ${nameCell}
                            ${numCmtCell}
                            ${ratingCell}
                            ${perConCell}
                        `;

                        modalBody.appendChild(row);
                    });

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    modal.style.display = 'flex';
                })
                .catch(error => {
                    resultsDiv.innerHTML = '<div class="error">åŠ è½½æ¦œå•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>';
                    console.error('åŠ è½½æ¦œå•é”™è¯¯:', error);
                });
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('leaderboard-modal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('leaderboard-modal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // é»˜è®¤åŠ è½½æœ€ç«çˆ†æ¦œå•
        document.addEventListener('DOMContentLoaded', function() {
            loadLeaderboard('top_popular');
        });
    </script>
</body>
</html>